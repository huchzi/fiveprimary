---
title: "Compare fundamentals"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r, include = FALSE}

library(here)
library(colorSpec)
library(data.table)
library(ggplot2)
library(magrittr)
library(openxlsx)

i_am("inst/MCVS_4primary.Rmd")

source(here("R", "functions.R"))

```

## Load data

```{r load fundamentals}

# For calculation, I use wavelengths between 390 and 780nm in steps of 2nm
wavelengths <- seq(390, 780, 2)

# Read fundamentals from Erlangen
load(here("data", "photoreceptor_sensitivities.rda"))
fundamentals_cord <- data.table(Wavelength = wavelengths, 
                                photoreceptor_spectral_sensitivities)
fundamentals_cord$melanopsin <- NULL

```

## LED spectra from Manchester

```{r read LED spectra}

led_spectra <- data.table(read.csv(here("data", "MCVS.csv")))
led_spectra$AMBER.LED <- NULL

ggplot(melt(led_spectra, id.vars = "Wavelength"), 
       aes(x = Wavelength, y = value, group = variable)) +
  geom_line() 

```

I'm not sure what luminances to use for calculating the spectra. However, this should not matter, so I will just pick 10cd/m^2 for each LED.

```{r}

led_luminances <- c(Red = 23, Green = 27, Blue = 4, Cyan = 22)

p_led <- 
  led_spectra %>%
  get_normalized_spectrum_matrix() %>%
  calculate_power_spectra(luminances = led_luminances, spectra = .)



```

This results in the following LED powers [W/m^2].

```{r}

apply(p_led, 2, sum)

```

## Calculate A-Matrices

### Fundamentals from Erlangen

```{r}

s_receptors <- 
  fundamentals_cord %>%
  get_normalized_spectrum_matrix() 

p_led <- 
  led_spectra %>%
  get_normalized_spectrum_matrix() %>%
  calculate_power_spectra(luminances = led_luminances, spectra = .)

a_matrix_cord <- create_A_matrix(P_led = p_led, s_receptors = s_receptors)

print(a_matrix_cord)



```
In Jan's spreadsheet, the A-Matrix is normalized, so that all colums add up to one. As a consequence, calculations with photoreceptor contrasts should be possible.

```{r}

# Calculate column sums
apply(a_matrix_cord, 2, sum)

```

### L-cone contrast of 10%

Comparison of the Michelson contrast in %. A negative signs means modulation in counterphase.

```{r}

maximize_contrasts <- function(x) { x / max(abs(x))}

maximize_contrasts(
  c(find_LED_contrasts(c(lcone = .1, mcone = 0, rod = 0, scone = 0), a_matrix_cord),
             lcone = .1)
) * 100

```

### M-cone contrast of 10%

Apparently, there is a considerable difference between calculations. Note that amber modulation is > 100% here, so that 10% M-cone contrast is above instrument gamut, but this should not matter here.

```{r}

maximize_contrasts(
  c(find_LED_contrasts(c(lcone = 0, mcone = .1, rod = 0, scone = 0), a_matrix_cord),
             mcone = .1)
) * 100

```
### Rod contrast of 10%

```{r}

maximize_contrasts(
  c(find_LED_contrasts(c(lcone = 0, mcone = 0, rod = .1, scone = 0), a_matrix_cord),
             rod = .1)
) * 100

```

### S-cone contrast of 10%

```{r}

maximize_contrasts(
  c(find_LED_contrasts(c(lcone = 0, mcone = 0, rod = 0, scone = .1), a_matrix_cord),
             scone = .1)
) * 100

```
